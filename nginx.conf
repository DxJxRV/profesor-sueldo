# Configuración NGINX para Sueldos México con SSG
# Esta configuración maneja:
# 1. Páginas estáticas prerenderizadas (SEO)
# 2. SPA fallback para rutas no prerenderizadas
# 3. Compresión y caché optimizados
# 4. API Proxy al backend

server {
    listen 80;
    listen [::]:80;
    server_name sueldosmexico.com www.sueldosmexico.com;

    # Redirigir HTTP a HTTPS (descomentar en producción)
    # return 301 https://$server_name$request_uri;
}

server {
    # listen 443 ssl http2;
    # listen [::]:443 ssl http2;
    listen 80;  # Para desarrollo sin SSL
    server_name sueldosmexico.com www.sueldosmexico.com;

    # SSL Certificates (configurar en producción)
    # ssl_certificate /etc/letsencrypt/live/sueldosmexico.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/sueldosmexico.com/privkey.pem;
    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_ciphers HIGH:!aNULL:!MD5;

    # Directorio raíz del proyecto
    root /var/www/sueldosmexico/dist;
    index index.html;

    # Charset
    charset utf-8;

    # Logs
    access_log /var/log/nginx/sueldosmexico-access.log;
    error_log /var/log/nginx/sueldosmexico-error.log;

    # Compresión Gzip
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/x-javascript
        text/xml
        application/xml
        application/xml+rss
        image/svg+xml;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # CORS Headers (ajustar según necesidad)
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;

    # ============================================
    # BACKEND API PROXY
    # ============================================
    location /api {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ============================================
    # ARCHIVOS ESTÁTICOS CON CACHÉ
    # ============================================

    # Assets con hash - caché largo (1 año)
    location ~* ^/assets/.*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Imágenes y fonts sin hash - caché medio (1 mes)
    location ~* \.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public";
        access_log off;
    }

    # Favicon
    location = /favicon.ico {
        expires 30d;
        add_header Cache-Control "public";
        access_log off;
    }

    # Robots.txt y Sitemap
    location = /robots.txt {
        expires 7d;
        add_header Cache-Control "public";
        access_log off;
    }

    location = /sitemap.xml {
        expires 1d;
        add_header Cache-Control "public";
        access_log off;
    }

    # ============================================
    # PÁGINAS PRERENDERIZADAS (SSG)
    # ============================================

    # Intentar servir archivo estático primero
    # Si no existe, servir index.html de la carpeta
    # Si tampoco existe, fallback a /index.html (SPA)

    # Profesiones: /cuanto-gana/:profesion
    location ~* ^/cuanto-gana/([a-z0-9\-]+)$ {
        try_files $uri $uri/index.html /index.html;
        expires 1d;
        add_header Cache-Control "public, must-revalidate";
    }

    # Estados: /salarios/por-estado/:estado
    location ~* ^/salarios/por-estado/([a-z0-9\-]+)$ {
        try_files $uri $uri/index.html /index.html;
        expires 1d;
        add_header Cache-Control "public, must-revalidate";
    }

    # Instituciones: /salarios/por-institucion/:institucion
    location ~* ^/salarios/por-institucion/([a-z0-9\-]+)$ {
        try_files $uri $uri/index.html /index.html;
        expires 1d;
        add_header Cache-Control "public, must-revalidate";
    }

    # Búsquedas: /buscar/:termino
    location ~* ^/buscar/([a-z0-9\-]+)$ {
        try_files $uri $uri/index.html /index.html;
        expires 1d;
        add_header Cache-Control "public, must-revalidate";
    }

    # ============================================
    # SPA FALLBACK
    # ============================================

    # Todas las demás rutas - servir index.html (SPA)
    location / {
        try_files $uri $uri/ /index.html;
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # Deshabilitar caché para index.html principal
    location = /index.html {
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # ============================================
    # ERROR PAGES
    # ============================================

    error_page 404 /index.html;
    error_page 500 502 503 504 /index.html;
}

# ============================================
# CONFIGURACIÓN ALTERNATIVA - SOLO STATIC
# (Usar si no tienes backend corriendo en el mismo servidor)
# ============================================

# server {
#     listen 80;
#     server_name sueldosmexico.com;
#     root /var/www/sueldosmexico/dist;
#     index index.html;
#
#     location / {
#         try_files $uri $uri/index.html $uri/ /index.html;
#     }
#
#     # Para el API, proxy a servidor remoto
#     location /api {
#         proxy_pass https://api.sueldosmexico.com;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#     }
# }
